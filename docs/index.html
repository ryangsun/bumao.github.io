<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  
  <title>布猫</title>
  <meta name="author" content="Ryan.G.Sun">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="布猫"/>

  
    <meta property="og:image" content=""/>
  

  <link rel="shortcut icon" href="/favicon.png">
  
  
<link rel="stylesheet" href="/css/style.css">

  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <!--<h1><a href="/">布猫</a></h1>-->
  <h1><a href="/"><img src="/img/logo_128.png" style="width:48px" title="布猫"/></a></h1>
  <h2><a href="/"></a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article id="post-Gitlab持续集成「PHP篇」" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-16T08:22:11.000Z"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">2022-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<p>PHP项目不要要编辑，一个job可以搞定。</p>
<p>发布节点用到的镜像<code>centos7-sshpass:1.0.0</code>详见 《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">stages:</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">deploy_dev:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  script:</span><br><span class="line">    - ls ./ -lah</span><br><span class="line">    # 清除原有</span><br><span class="line">    - sshpass -p abc ssh -p 1234 -o StrictHostKeychecking=no root@localhost &quot;rm -fr /path/to/pub/*&quot;</span><br><span class="line">    # 拷贝文件包</span><br><span class="line">    - sshpass -p abc scp -o StrictHostKeyChecking=no -P 1234 -r ./* root@localhost:/path/to/pub/</span><br><span class="line">  tags:</span><br><span class="line">    - runner_test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - dev_ver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">deploy_test:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  script:</span><br><span class="line">    - ls ./ -lah</span><br><span class="line">    # 清除原有</span><br><span class="line">    - sshpass -p abc ssh -p 1234 -o StrictHostKeychecking=no root@localhost &quot;rm -fr /path/to/pub/*&quot;</span><br><span class="line">    # 拷贝文件包</span><br><span class="line">    - sshpass -p abc scp -o StrictHostKeyChecking=no -P 1234 -r ./* root@localhost:/path/to/pub/</span><br><span class="line">  tags:</span><br><span class="line">    - runner_test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - dev_ver</span><br></pre></td></tr></table></figure>

<p>如果：</p>
<ul>
<li>项目根目录下的 <code>dev_ver</code>被修改，则会触发 <code>deploy_dev:</code></li>
<li>项目根目录下的 <code>test_ver</code>被修改，则会触发 <code>deploy_test:</code></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Gitlab持续集成「VUE篇」" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-16T08:22:11.000Z"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">2022-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<p>java、vue等项目需要编译，所以，至少有两个job，一个是用 nodejs 镜像打dist包，一个是发布到对应位置。</p>
<p>发布节点用到的镜像<code>centos7-sshpass:1.0.0</code>详见 《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">stages:</span><br><span class="line">  - prepare</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">prepare:</span><br><span class="line">  stage: prepare</span><br><span class="line">  image: &#x27;node:16.14.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    key: &quot;$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - node_modules/</span><br><span class="line">      - dist/</span><br><span class="line">  script:</span><br><span class="line">    - npm install</span><br><span class="line">    - npm run build:prod</span><br><span class="line">    - ls dist/ -lah</span><br><span class="line">  tags:</span><br><span class="line">    - runner_test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - dev_ver</span><br><span class="line">      - test_ver</span><br><span class="line">deploy_dev:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    key: &quot;$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - dist/</span><br><span class="line">  script:</span><br><span class="line">    - ls dist/</span><br><span class="line">    # 清除原有</span><br><span class="line">    - sshpass -p abc ssh user@localhost -o StrictHostKeychecking=no &quot;rm -fr /path/to/pub/*&quot;</span><br><span class="line">    # 拷贝dist包</span><br><span class="line">    - sshpass -p abcc scp -o StrictHostKeyChecking=no -p -r dist/*.* user@localhost:/path/to/pub/</span><br><span class="line">  tags:</span><br><span class="line">    - runner_test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - dev_ver</span><br><span class="line"></span><br><span class="line">deploy_test:</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    key: &quot;$CI_COMMIT_REF_NAME&quot;</span><br><span class="line">    paths:</span><br><span class="line">      - dist/</span><br><span class="line">  script:</span><br><span class="line">    - ls dist/</span><br><span class="line">    # 清除原有</span><br><span class="line">    - sshpass -p abc ssh user@localhost -o StrictHostKeychecking=no &quot;rm -fr /path/to/pub/*&quot;</span><br><span class="line">    # 拷贝dist包</span><br><span class="line">    - sshpass -p abcc scp -o StrictHostKeyChecking=no -p -r dist/*.* user@localhost:/path/to/pub/</span><br><span class="line">  tags:</span><br><span class="line">    - runner_test</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - test_ver</span><br></pre></td></tr></table></figure>

<p>以上这个案例，定义了两个环节 <code>prepare</code>和<code>deploy</code>，有三个job：</p>
<ul>
<li><code>prepare:</code> 在dev_ver或test_ver被修改时会被触发</li>
<li><code>deploy_dev:</code> 在dev_ver被修改时会被触发</li>
<li><code>deploy_test:</code> 在test_ver被修改时会被触发</li>
</ul>
<p>那么，如果：</p>
<ul>
<li>项目根目录下的 <code>dev_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_dev:</code></li>
<li>项目根目录下的 <code>test_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_test:</code></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Gitlab持续集成「springboot篇」" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-16T08:21:11.000Z"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">2022-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<p>java、vue等项目需要编译，所以，至少有两个job，一个是用 maven镜像打jar包，一个是发布到对应位置。</p>
<p>发布节点用到的镜像<code>centos7-sshpass:1.0.0</code>详见 《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># 定义了两个流程</span><br><span class="line">stages:</span><br><span class="line">  - prepare</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">prepare:    # job的名称，可以随便起</span><br><span class="line">  stage: prepare    #这里要跟 stages 里面定义的保持一致</span><br><span class="line">  image: &#x27;maven:3.6.3-openjdk-8&#x27;    #用哪个镜像</span><br><span class="line">  cache:    # 缓存</span><br><span class="line">    policy: pull-push   #缓存方式 有 pull push pull-push</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/     #把target目录缓冲下来给下一步用</span><br><span class="line">  script:   #执行脚本</span><br><span class="line">    - mvn -v &amp;&amp; java -version</span><br><span class="line">    - mvn clean install</span><br><span class="line">  tags:</span><br><span class="line">    - java01    #对应的Runner的TAG，多个runner可以用同样的tag，到时候gitlab来分配具体用哪个runner来执行</span><br><span class="line">  only:</span><br><span class="line">    changes:    此步骤（job）通过文件修改来触发，下面定义的意思是，这两个文件其中一个有修改即触发执行</span><br><span class="line">      - dev_ver</span><br><span class="line">      - test_ver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">deploy_dev:     #往dev版发布</span><br><span class="line">  stage: deploy     #这里要跟 stages 里面定义的保持一致</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    policy: pull  #只读不写</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/</span><br><span class="line">  script:</span><br><span class="line">    - ls ./target/</span><br><span class="line">    # 拷贝jar包</span><br><span class="line">    - sshpass -p abcd scp -o StrictHostKeyChecking=no -P 1234 target/demo-0.0.1-SNAPSHOT.jar root@localhost:/app/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">    # 运行脚本</span><br><span class="line">    - sshpass -p abcd ssh -p 1234 root@localhost &quot;/app/jenkins_restart.sh demo-0.0.1-SNAPSHOT &gt;&gt; /app/jenkins_restart.log&quot;</span><br><span class="line">  tags:</span><br><span class="line">    - java01</span><br><span class="line">  only:</span><br><span class="line">    changes:    #这里仅针对dev_ver的修改触发</span><br><span class="line">      - dev_ver</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">deploy_test:    #往test版发包</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    policy: pull  #只读不写</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/</span><br><span class="line">  script:</span><br><span class="line">    - 。。。。。。</span><br><span class="line">  tags:</span><br><span class="line">    - java01</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - test_ver    #仅 文件 test_ver修改时候触发</span><br></pre></td></tr></table></figure>

<p>以上这个案例，定义了两个环节 <code>prepare</code>和<code>deploy</code>，有三个job：</p>
<ul>
<li><code>prepare:</code> 在dev_ver或test_ver被修改时会被触发</li>
<li><code>deploy_dev:</code> 在dev_ver被修改时会被触发</li>
<li><code>deploy_test:</code> 在test_ver被修改时会被触发</li>
</ul>
<p>那么，如果：</p>
<ul>
<li>项目根目录下的 <code>dev_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_dev:</code></li>
<li>项目根目录下的 <code>test_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_test:</code></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-为Gitlab持续集成打造一个部署用的docker" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-16T08:20:11.000Z"><a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">2022-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<p>因为docker化部署的Runner，每一部都需要在容器中完成，针对没有完全使用k8等容器化运维的项目或者项目构建过程中需要做额外操作的ci/cd流程，使用官方容器就比较尴尬：</p>
<ul>
<li>打包好的目标文件，在maven、nodejs容器因为没有对应的命令，无法上传到指定位置</li>
<li>ci/cd过程复杂，需要跟其他服务交互</li>
</ul>
<p>这种情况，咱们就得自己包docker image来给Runner用。</p>
<h2 id="ceontos-sshpass"><a href="#ceontos-sshpass" class="headerlink" title="ceontos-sshpass"></a>ceontos-sshpass</h2><p>为了应对以上问题，笔者自己包了个发版的docker，地址在 <a target="_blank" rel="noopener" href="https://github.com/ryangsun/centos7-sshpass">https://github.com/ryangsun/centos7-sshpass</a></p>
<h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ryangsun/centos7-sshpass.git</span><br><span class="line">chmod 700 build-image.sh</span><br><span class="line">./build-image.sh</span><br></pre></td></tr></table></figure>
<p>默认创建的docker镜像为 <code>centos7-sshpass:1.0.0</code>，233M大小。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Gitlab持续集成详细配置与工作原理" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-16T08:19:11.000Z"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">2022-03-16</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<h2 id="Gitlab-Runner-窍门"><a href="#Gitlab-Runner-窍门" class="headerlink" title="Gitlab Runner 窍门"></a>Gitlab Runner 窍门</h2><h3 id="解决gitlab-Runner-执行-job时反复拉取镜像的问题"><a href="#解决gitlab-Runner-执行-job时反复拉取镜像的问题" class="headerlink" title="解决gitlab Runner 执行 job时反复拉取镜像的问题"></a>解决gitlab Runner 执行 job时反复拉取镜像的问题</h3><p>编辑 <code>/etc/gitlab-runner/config.toml</code></p>
<p>找到 shm_size = 0 段<br>添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pull_policy = &quot;if-not-present&quot;</span><br></pre></td></tr></table></figure>

<h3 id="每次都要cache的内容可直接放到配置文件中"><a href="#每次都要cache的内容可直接放到配置文件中" class="headerlink" title="每次都要cache的内容可直接放到配置文件中"></a>每次都要cache的内容可直接放到配置文件中</h3><p>因为在docker方式中，每次job拉起镜像，都是崭新的，所以在构建Java项目时，<code>.m2</code>文件夹不存在，导致每次都需要重新下载全量jar包。<br>的确可以通过 gitlab-ci.yml中的cache段来解决，但每次写实在太麻烦，所以这个配置，也可以通过编辑 <code>/etc/gitlab-runner/config.toml</code>来解决。</p>
<p>找到 <code>volumes = [&quot;/cache&quot;]</code>段，修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volumes = [&quot;/cache&quot;,&quot;/dockerdata/gitlab-runner-java01/root/.m2:/root/.m2&quot;]</span><br></pre></td></tr></table></figure>
<p>其中<code>&quot;/dockerdata/gitlab-runner-java01/root/.m2:/root/.m2&quot;</code> 与docker -v参数的传值类似，冒号前面是宿主机路径，后面是容器内路径。</p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><ul>
<li>不管我们用什么方式安装的gitlab，本身并不具备cicd功能，需要安装配套的<code>Runner</code>来具体做事。</li>
<li>Docker方式部署的runner也不直接做打包发布的事情，而是通过定义不同环节用哪个docker容器来完成任务，这种方式下的runner，其实就是个管控器。</li>
<li>何时触发构建动作、由谁执行构建动作、如何构建，需要在项目根目录下的 <code>gitlab-ci.yml</code> 来定义。</li>
</ul>
<h2 id="运行方式"><a href="#运行方式" class="headerlink" title="运行方式"></a>运行方式</h2><h3 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h3><p>gitlab的 pipeline既可以自动触发，也可以通过gitlab界面的cicd相关页面手动触发，这取决于在gitlab-ci.yml中如何配置。</p>
<ul>
<li>手动触发：<code>gitlab项目页面</code> -&gt; <code>左侧&quot;CI/CD&quot;</code> -&gt; <code>右侧按钮&quot;Run Pipeline&quot;</code></li>
<li>自动触发：<code>gitlab-ci.yml</code> 中，每个job的 <code>only</code> 段，方式非常灵活，可按照 分支提交动作、文件修改动作 等等方式。</li>
</ul>
<h4 id="only案例，修改文件触发构建"><a href="#only案例，修改文件触发构建" class="headerlink" title="only案例，修改文件触发构建"></a>only案例，修改文件触发构建</h4><p>作为开发人员，最方便的莫过于修改本地文件然后提交了，以下方式，只需要在项目根目录创建两个文件<code>dev_ver</code>和<code>test_ver</code>，分别对应自动部署到开发版和测试版。<br>当gitlab获取到提交请求时，会自动扫描gitlab-ci.yml文件，如果对应的文件有修改，则进行对应的构建和发布操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">only:</span><br><span class="line">  changes:</span><br><span class="line">    - dev_ver</span><br><span class="line">    - test_ver</span><br></pre></td></tr></table></figure>
<h4 id="only案例，手动触发"><a href="#only案例，手动触发" class="headerlink" title="only案例，手动触发"></a>only案例，手动触发</h4><p>如果想通在gitlab网页界面上操作，可采用这种变量传值方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">only:</span><br><span class="line">  variables:</span><br><span class="line">    - $RELEASE == &quot;dev&quot;</span><br><span class="line">    - $RELEASE == &quot;test&quot;</span><br></pre></td></tr></table></figure>
<p>此时，<code>gitlab项目页面</code> -&gt; <code>左侧&quot;CI/CD&quot;</code> -&gt; <code>右侧按钮&quot;Run Pipeline&quot;</code>，在对应的页面中变量栏key输入 <code>RELEASE</code>,value栏输入<code>dev</code>，则会触发此规则。</p>
<h3 id="阶段"><a href="#阶段" class="headerlink" title="阶段"></a>阶段</h3><p>以下信息描述了两个阶段 <code>prepare</code>和<code>deploy</code>阶段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stages:</span><br><span class="line">- prepare</span><br><span class="line">- deploy</span><br></pre></td></tr></table></figure>
<p>当然，可以制定更多的阶段（Job），对于docker方式的Runner而言，每个阶段都会临时启动一个docker来执行对应的任务。</p>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><p>在每个执行阶段中，我们需要定义：</p>
<ul>
<li>触发规则 only</li>
<li>采用的镜像 image</li>
<li>运行的脚本 script</li>
<li>缓冲（为了下一环节能用到上一环节的作业成果） cache</li>
</ul>
<h4 id="执行案例"><a href="#执行案例" class="headerlink" title="执行案例"></a>执行案例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># 定义了两个流程</span><br><span class="line">stages:</span><br><span class="line">  - prepare</span><br><span class="line">  - deploy</span><br><span class="line"></span><br><span class="line">prepare:    # job的名称，可以随便起</span><br><span class="line">  stage: prepare    #这里要跟 stages 里面定义的保持一致</span><br><span class="line">  image: &#x27;maven:3.6.3-openjdk-8&#x27;    #用哪个镜像</span><br><span class="line">  cache:    # 缓存</span><br><span class="line">    policy: pull-push   #缓存方式 有 pull push pull-push</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/     #把target目录缓冲下来给下一步用</span><br><span class="line">  script:   #执行脚本</span><br><span class="line">    - mvn -v &amp;&amp; java -version</span><br><span class="line">    - mvn clean install</span><br><span class="line">  tags:</span><br><span class="line">    - java01    #对应的Runner的TAG，多个runner可以用同样的tag，到时候gitlab来分配具体用哪个runner来执行</span><br><span class="line">  only:</span><br><span class="line">    changes:    此步骤（job）通过文件修改来触发，下面定义的意思是，这两个文件其中一个有修改即触发执行</span><br><span class="line">      - dev_ver</span><br><span class="line">      - test_ver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">deploy_dev:     #往dev版发布</span><br><span class="line">  stage: deploy     #这里要跟 stages 里面定义的保持一致</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    policy: pull  #只读不写</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/</span><br><span class="line">  script:</span><br><span class="line">    - ls ./target/</span><br><span class="line">    # 拷贝jar包</span><br><span class="line">    - sshpass -p abcd scp -o StrictHostKeyChecking=no -P 1234 target/demo-0.0.1-SNAPSHOT.jar root@localhost:/app/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line">    # 运行脚本</span><br><span class="line">    - sshpass -p abcd ssh -p 1234 root@localhost &quot;/app/jenkins_restart.sh demo-0.0.1-SNAPSHOT &gt;&gt; /app/jenkins_restart.log&quot;</span><br><span class="line">  tags:</span><br><span class="line">    - java01</span><br><span class="line">  only:</span><br><span class="line">    changes:    #这里仅针对dev_ver的修改触发</span><br><span class="line">      - dev_ver</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">deploy_test:    #往test版发包</span><br><span class="line">  stage: deploy</span><br><span class="line">  image: &#x27;centos7-sshpass:1.0.0&#x27;</span><br><span class="line">  cache:</span><br><span class="line">    policy: pull  #只读不写</span><br><span class="line">    key: $&#123;CI_COMMIT_REF_SLUG&#125;  #按照分支进行缓冲</span><br><span class="line">    paths:</span><br><span class="line">      - target/</span><br><span class="line">  script:</span><br><span class="line">    - 。。。。。。</span><br><span class="line">  tags:</span><br><span class="line">    - java01</span><br><span class="line">  only:</span><br><span class="line">    changes:</span><br><span class="line">      - test_ver    #仅 文件 test_ver修改时候触发</span><br></pre></td></tr></table></figure>

<p>以上这个案例，定义了两个环节 <code>prepare</code>和<code>deploy</code>，有三个job：</p>
<ul>
<li><code>prepare:</code> 在dev_ver或test_ver被修改时会被触发</li>
<li><code>deploy_dev:</code> 在dev_ver被修改时会被触发</li>
<li><code>deploy_test:</code> 在test_ver被修改时会被触发</li>
</ul>
<p>那么，如果：</p>
<ul>
<li>项目根目录下的 <code>dev_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_dev:</code></li>
<li>项目根目录下的 <code>test_ver</code>被修改，则会触发 <code>prepare:</code> 和 <code>deploy_test:</code></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Gitlab持续集成Runner安装与配置" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2022-03-15T08:19:11.000Z"><a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">2022-03-15</a></time>
      
      
  
    <h1 class="title"><a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlib持续集成Runner的安装与配置</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>《<a href="/2022/03/15/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90Runner%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Gitlab持续集成Runner的安装与配置</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E8%AF%A6%E7%BB%86%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">Gitlab持续集成详细配置与工作原理</a>》</p>
<p>《<a href="/2022/03/16/%E4%B8%BAGitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E9%83%A8%E7%BD%B2%E7%94%A8%E7%9A%84docker/">为Gitlab持续集成打造一个部署用的docker</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8Cspringboot%E7%AF%87%E3%80%8D/">Gitlab持续集成「springboot篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CPHP%E7%AF%87%E3%80%8D/">Gitlab持续集成「PHP篇」</a>》</p>
<p>《<a href="/2022/03/16/Gitlab%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E3%80%8CVUE%E7%AF%87%E3%80%8D/">Gitlab持续集成「VUE篇」</a>》</p>
<p>首先，gitlab不做持续集成的事儿，只是发送指令和接收结果，实际做cicd的是Runner。安装和配置runner有集中方式，这里记录两种：</p>
<h2 id="docker方式，非常轻便灵活"><a href="#docker方式，非常轻便灵活" class="headerlink" title="docker方式，非常轻便灵活"></a>docker方式，非常轻便灵活</h2><p>展开容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name gitlab-runner-docker \</span><br><span class="line">--restart always \</span><br><span class="line">-v /dockerdata/gitlab-runner-docker/etc/gitlab-runner:/etc/gitlab-runner \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">gitlab/gitlab-runner:latest</span><br></pre></td></tr></table></figure>
<p>接入对应的gitlab</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it gitlab-runner-docker gitlab-runner register</span><br></pre></td></tr></table></figure>
<p>接着会询问gitlab的地址、token ，这两个信息，可以在我们自己gitlab的 admin-&gt;概览-&gt;Runner中查询到。</p>
<p>之后会询问 这个runner的名字和tag，tag这里要注意，会影响到实际cicd中的调用，因为跑自动化的时候是可以通过tag来指定runner的。</p>
<p>交互式提问结束后，在gitlab的Runner页面，应该有对应的Runner注册上来了。</p>
<h2 id="Centos中通过ssh连接"><a href="#Centos中通过ssh连接" class="headerlink" title="Centos中通过ssh连接"></a>Centos中通过ssh连接</h2><p>添加yum源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash</span><br></pre></td></tr></table></figure>

<p>安装runner</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gitlab-ci-multi-runner</span><br></pre></td></tr></table></figure>
<p>向GitLab-CI注册runner</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ci-multi-runner register</span><br></pre></td></tr></table></figure>
<p>后面的步骤跟docker方式类似，gitlab的路径、token，连接方式选ssh，然后把本机的IP、ssh端口、账号密码录入进去。</p>
<h2 id="配置过程（以docker方式为例）"><a href="#配置过程（以docker方式为例）" class="headerlink" title="配置过程（以docker方式为例）"></a>配置过程（以docker方式为例）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># docker exec -it gitlab-runner-java01 gitlab-runner register</span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=24 revision=5316d4ac version=14.6.0</span><br><span class="line">Running in system-mode.                            </span><br><span class="line">                                                   </span><br><span class="line">Enter the GitLab instance URL (for example, https://gitlab.com/):</span><br><span class="line">&lt;这里输入gitlab私仓的url&gt;</span><br><span class="line">Enter the registration token:</span><br><span class="line">&lt;这里输入runner的token&gt;</span><br><span class="line">Enter a description for the runner:</span><br><span class="line">[007fa02670d1]: &lt;给这个runner起个名字，会显示在gitlab中&gt;</span><br><span class="line">Enter tags for the runner (comma-separated):</span><br><span class="line">&lt;这里输入tag，跑任务的时候可以通过 tags 来指定&gt;</span><br><span class="line">Registering runner... succeeded                     runner=rANP_dLs</span><br><span class="line">Enter an executor: docker, docker-ssh, parallels, shell, virtualbox, docker+machine, custom, ssh, docker-ssh+machine, kubernetes:</span><br><span class="line">&lt;运行方式，这里写 docker&gt;</span><br><span class="line">Enter the default Docker image (for example, ruby:2.6):</span><br><span class="line">&lt;默认运行容器，如果在job中不指定容器，默认采用的运行容器，这里我添了 tico/docker&gt;</span><br><span class="line">Runner registered successfully. Feel free to start it, but if it&#x27;s running already the config should be automatically reloaded! </span><br></pre></td></tr></table></figure>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Harbor SSL避坑指南" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2021-07-05T08:19:11.000Z"><a href="/2021/07/05/Harbor%20SSL%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/">2021-07-05</a></time>
      
      
  
    <h1 class="title"><a href="/2021/07/05/Harbor%20SSL%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97/">Harbor SSL避坑指南</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <p>Harbor的安装与配置请参考这里<a href="/2021/07/03/Harbor%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Harbor的安装与配置</a></p>
<p>Docker默认情况下，push和pull对应的仓库均需要ssl加密，如果我们在内网采用Harbor作为私仓，有两种方案可以解决：</p>
<ul>
<li>Harbor开启ssl</li>
<li>docker侧修改配置文件，并且需重启docker服务</li>
</ul>
<p>实际情况是，docker因为承载的服务较多，无法选择重启方案，那么就必须采用第一种方案。这种方案：</p>
<ul>
<li>harbor侧开启ssl</li>
<li>对应的docker服务侧需要拷贝对应的签名证书</li>
</ul>
<h2 id="Harbor开启ssl"><a href="#Harbor开启ssl" class="headerlink" title="Harbor开启ssl"></a>Harbor开启ssl</h2><h3 id="创建ssl证书"><a href="#创建ssl证书" class="headerlink" title="创建ssl证书"></a>创建ssl证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">创建一个证书文件夹</span><br><span class="line">mkdir harbor_cert &amp;&amp; cd harbor_cert</span><br><span class="line"># 创建ca时，根据提示输入 IP地址</span><br><span class="line">openssl req  -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt</span><br><span class="line">openssl req  -newkey rsa:4096 -nodes -sha256 -keyout server.key -out server.csr</span><br><span class="line"># 把IP地址写入到文件中</span><br><span class="line">echo subjectAltName = IP:xx.xx.xx.xx &gt; extfile.cnf</span><br><span class="line"># 生成 cr</span><br><span class="line">openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -extfile extfile.cnf -out server.crt</span><br></pre></td></tr></table></figure>

<h3 id="配置Harbor"><a href="#配置Harbor" class="headerlink" title="配置Harbor"></a>配置Harbor</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd harbor2.3/</span><br><span class="line">vim harbor.yml</span><br><span class="line"></span><br><span class="line">#修改对应的配置项目：</span><br><span class="line"># https related config</span><br><span class="line">https:</span><br><span class="line">  # https port for harbor, default is 443</span><br><span class="line">  port: 10443</span><br><span class="line">  # The path of cert and key files for nginx</span><br><span class="line">  certificate: /root/harbor_cert/server.crt</span><br><span class="line">  private_key: /root/harbor_cert/server.key</span><br><span class="line">#保存</span><br><span class="line"></span><br><span class="line">#使配置生效</span><br><span class="line">./prepare</span><br><span class="line"></span><br><span class="line">#重启Harbor</span><br><span class="line">docker-compose down -v</span><br><span class="line">docker-compose up -v</span><br></pre></td></tr></table></figure>

<h3 id="拷贝对应签名文件到docker服务侧"><a href="#拷贝对应签名文件到docker服务侧" class="headerlink" title="拷贝对应签名文件到docker服务侧"></a>拷贝对应签名文件到docker服务侧</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp server.crt  root@&lt;docker侧主机&gt;:/etc/docker/certs.d/&lt;Harbor主机IP&gt;:&lt;harbor主机端口&gt;/</span><br><span class="line">scp ca.crt  root@&lt;docker侧主机&gt;:/etc/docker/certs.d/&lt;Harbor主机IP&gt;:&lt;harbor主机端口&gt;/</span><br><span class="line">scp server.key root@&lt;docker侧主机&gt;:/etc/docker/certs.d/&lt;Harbor主机IP&gt;:&lt;harbor主机端口&gt;/</span><br></pre></td></tr></table></figure>

<p>这里注意的是：如果Harbor侧ssl的监听端口为443，则docker侧的路径为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/docker/certs.d/&lt;Harbor主机IP&gt;/</span><br></pre></td></tr></table></figure>

<p>否则为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/docker/certs.d/&lt;Harbor主机IP&gt;:&lt;harbor主机端口&gt;/</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login &lt;Harbor主机IP&gt;:&lt;harbor主机端口&gt;</span><br></pre></td></tr></table></figure>

<p>这样，无需重启docker服务，即可实现内网harbor私仓的正常使用。</p>
<h2 id="相关的docker对应的官方文档"><a href="#相关的docker对应的官方文档" class="headerlink" title="相关的docker对应的官方文档"></a>相关的docker对应的官方文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/insecure/">https://docs.docker.com/registry/insecure/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/security/certificates/">https://docs.docker.com/engine/security/certificates/</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-用DinD方式构建docker" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2021-07-05T07:19:11.000Z"><a href="/2021/07/05/%E7%94%A8DinD%E6%96%B9%E5%BC%8F%E6%9E%84%E5%BB%BAdocker/">2021-07-05</a></time>
      
      
  
    <h1 class="title"><a href="/2021/07/05/%E7%94%A8DinD%E6%96%B9%E5%BC%8F%E6%9E%84%E5%BB%BAdocker/">用DinD方式构建docke用DinD方式构建docker</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="Docker-in-Docker-dind"><a href="#Docker-in-Docker-dind" class="headerlink" title="Docker in Docker(dind)"></a>Docker in Docker(dind)</h2><p>Docker in Docker(dind) image可以用于Jenkins做build， 可以在一台机器上起多个docker image，每个image里面安装不同的第三方，形成不同的build环境，然后可以将待编译的代码SCP或GIT过去，用指定账号SSH来进行编译，达到一个机器多种编译环境的效果，提高了效率。Docker in Docker(dind) 镜像基于centos7，可用于jenkins打包编译：</p>
<ul>
<li>基础镜像: centos7 </li>
<li>内置用户：jenkinsbuild, 密码: jenkinsbuild, 构建文件夹: /home/jenkinsbuild/ci-jenkins</li>
<li>采用ssh login方式登录</li>
</ul>
<h2 id="构建和使用镜像"><a href="#构建和使用镜像" class="headerlink" title="构建和使用镜像"></a>构建和使用镜像</h2><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-centos7-dind</span><br></pre></td></tr></table></figure>

<h3 id="展开容器"><a href="#展开容器" class="headerlink" title="展开容器"></a>展开容器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 22 \</span><br><span class="line">--name=centos7-dind \</span><br><span class="line">-e TZ=Asia/Shanghai \</span><br><span class="line">-e LANG=en_US.UTF-8  \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /usr/bin/docker:/usr/bin/docker \</span><br><span class="line">centos7-dind:1.0.0</span><br></pre></td></tr></table></figure>

<h3 id="将打代码copy到容器"><a href="#将打代码copy到容器" class="headerlink" title="将打代码copy到容器"></a>将打代码copy到容器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P \&lt;port\&gt; -r \&lt;buildsourcecode\&gt; jenkinsbuild@localhost:/home/jenkinsbuild/ci-jenkins/</span><br></pre></td></tr></table></figure>

<h3 id="ssh-登录进去"><a href="#ssh-登录进去" class="headerlink" title="ssh 登录进去"></a>ssh 登录进去</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p \&lt;port\&gt; jenkinsbuild@localhost  </span><br></pre></td></tr></table></figure>

<h3 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将对对应公钥copy到 /home/jenkinsbuild/ 对应位置即可。</span><br></pre></td></tr></table></figure>



<h2 id="git地址"><a href="#git地址" class="headerlink" title="git地址"></a>git地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/ryangsun/centos7-dind">https://github.com/ryangsun/centos7-dind</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Jenkins远程docker构建方案" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2021-07-05T02:19:11.000Z"><a href="/2021/07/05/Jenkins%E8%BF%9C%E7%A8%8Bdocker%E6%9E%84%E5%BB%BA%E6%96%B9%E6%A1%88/">2021-07-05</a></time>
      
      
  
    <h1 class="title"><a href="/2021/07/05/Jenkins%E8%BF%9C%E7%A8%8Bdocker%E6%9E%84%E5%BB%BA%E6%96%B9%E6%A1%88/">Jenkins远程docker构建方案</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>Jenkins，包括idea，有很多集成方案构建docker，但是因为网络结构、构建环境等客观原因，集成性的方案并不能满足需求。如：</p>
<ul>
<li>Jenkins权限限制；</li>
<li>Jenkins已经是docker化部署，无法嵌套集成方案；</li>
<li>构建环境不唯一，需要多个docker环境分别构建；</li>
<li>Jenkins端无私仓权限，无法把构建好的docker部署到指定位置。</li>
</ul>
<p>这时，基于DinD的构建方案就非常方便了。</p>
<h2 id="安装与部署DinD容器"><a href="#安装与部署DinD容器" class="headerlink" title="安装与部署DinD容器"></a>安装与部署DinD容器</h2><p>容器的Dockerfile见这里：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ryangsun/centos7-dind">https://github.com/ryangsun/centos7-dind</a></p>
<p>安装和部署介绍见</p>
<h2 id="docker构建环境搭建"><a href="#docker构建环境搭建" class="headerlink" title="docker构建环境搭建"></a>docker构建环境搭建</h2><h3 id="免密登录"><a href="#免密登录" class="headerlink" title="免密登录"></a>免密登录</h3><p>1、将jenkins对应使用的私钥copy到dind容器的对应文件中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P &lt;DinD容器端口&gt; &lt;Jenkins私钥文件&gt; &lt;DinD容器&gt;:/home/jenkinsbuild/.ssh/....</span><br></pre></td></tr></table></figure>

<p>2、Jenkins创建新的远程主机连接</p>
<p>3、Jenkins SSH Publishers配置：</p>
<p><img src="https://i.loli.net/2021/07/05/sJ3YfLiAhFHDrzN.png" alt="image-20210705115301268"></p>
<p>第一步：针对一般的java项目，需要将jenkins打包好的jar文件和对应的Dockerfile拷贝到DinD容器。上图中，我们开了两个Transer Set，一个拷贝了.jar文件，一个拷贝了项目对应的Dockerfile。</p>
<p>第二步：远程执行命令构建docker:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#进入构建目录并构建Docker</span><br><span class="line">cd ~/ci-jenkins/$&#123;JOB_NAME&#125; &amp;&amp; docker build -t &lt;私仓IP&gt;:&lt;私仓端口&gt;/mytest/$&#123;JOB_NAME&#125;:$&#123;BUILD_ID&#125; .</span><br><span class="line">#将构建好的docker推到私仓</span><br><span class="line">docker push &lt;私仓IP&gt;:&lt;私仓端口&gt;/mytest/$&#123;JOB_NAME&#125;:$&#123;BUILD_ID&#125;</span><br><span class="line">#推私仓成功后，删除本地的docker image</span><br><span class="line">docker rmi &lt;私仓IP&gt;:&lt;私仓端口&gt;/mytest/$&#123;JOB_NAME&#125;:$&#123;BUILD_ID&#125;</span><br></pre></td></tr></table></figure>

<p>第三步：触发后续操作，如Rancher构建等。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article id="post-Harbor的安装与配置" class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time class="dt-published" datetime="2021-07-03T07:19:11.000Z"><a href="/2021/07/03/Harbor%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">2021-07-03</a></time>
      
      
  
    <h1 class="title"><a href="/2021/07/03/Harbor%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">Harbor的安装与配置</a></h1>
  

    </header>
    <div class="e-content entry" itemprop="articleBody">
      
        <h2 id="Harbor简介"><a href="#Harbor简介" class="headerlink" title="Harbor简介"></a>Harbor简介</h2><p>Harbor 是由 VMware 公司中国团队为企业用户设计的 Registry server 开源项目，包括了权限管理(RBAC)、LDAP、审计、管理界面、自我注册、HA 等企业必需的功能，同时针对中国用户的特点，设计镜像复制和中文支持等功能。</p>
<p><img src="https://static.oschina.net/uploads/space/2016/1117/163439_2f9X_2671340.png"></p>
<p>作为一个企业级私有 Registry 服务器，Harbor 提供了更好的性能和安全。提升用户使用 Registry 构建和运行环境传输镜像的效率。Harbor 支持安装在多个 Registry 节点的镜像资源复制，镜像全部保存在私有 Registry 中， 确保数据和知识产权在公司内部网络中管控。另外，Harbor 也提供了高级的安全特性，诸如用户管理，访问控制和活动审计等。</p>
<h3 id="Harbor的官网"><a href="#Harbor的官网" class="headerlink" title="Harbor的官网"></a>Harbor的官网</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://goharbor.io/</span><br></pre></td></tr></table></figure>

<h3 id="Harbor的github地址"><a href="#Harbor的github地址" class="headerlink" title="Harbor的github地址"></a>Harbor的github地址</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/goharbor/harbor</span><br></pre></td></tr></table></figure>

<p>(已经有15.2K的star了)</p>
<h2 id="安装Harbor"><a href="#安装Harbor" class="headerlink" title="安装Harbor"></a>安装Harbor</h2><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><p>宿主机已安装好docker和docker-compose，具体安装方案这里不不展开。</p>
<h3 id="下载-amp-解压"><a href="#下载-amp-解压" class="headerlink" title="下载&amp;解压"></a>下载&amp;解压</h3><p>Harbor有两个大版本，一是1.x，另外是2.x，据说2.x优化了很多，所以这里采用2.3.0这个版本，下载离线安装包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.3.0/harbor-offline-installer-v2.3.0.tgz</span><br><span class="line">tar zxvf harbor-offline-installer-v2.3.0.tgz</span><br><span class="line">cd harbor</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>将配置模板copy一份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure>

<p>编辑配置模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim harbor.yml</span><br></pre></td></tr></table></figure>

<p>主要修改以下几个地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># The IP address or hostname to access admin UI and registry service.</span><br><span class="line"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span><br><span class="line">hostname: &lt;你的harbor的域名或者IP(不加端口号)&gt;</span><br><span class="line"></span><br><span class="line"># http related config</span><br><span class="line">http:</span><br><span class="line">  # port for http, default is 80. If https enabled, this port will redirect to https port</span><br><span class="line">  port: &lt;http协议监听的端口&gt;</span><br><span class="line"></span><br><span class="line"># https related config</span><br><span class="line">https:</span><br><span class="line">  # https port for harbor, default is 443</span><br><span class="line">  port: &lt;https协议监听的端口&gt;</span><br><span class="line">  # The path of cert and key files for nginx</span><br><span class="line">  certificate: &lt;.crt证书文件的路径&gt;</span><br><span class="line">  private_key: &lt;.key证书文件的路径&gt;</span><br></pre></td></tr></table></figure>

<p>保存后执行配置脚本，使刚才的配置生效</p>
<h3 id="执行配置脚本"><a href="#执行配置脚本" class="headerlink" title="执行配置脚本"></a>执行配置脚本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./prepare</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure>

<p>如果之后修改配置再次启动，此步骤可以省略。</p>
<p>安装成功后，即可在 <a target="_blank" rel="noopener" href="https://youip/">https://youip</a> 上访问harbor了，初始帐号为 admin 初始密码为 Harbor12345 。</p>
<h2 id="一些常用命令"><a href="#一些常用命令" class="headerlink" title="一些常用命令"></a>一些常用命令</h2><h3 id="启动Harbor"><a href="#启动Harbor" class="headerlink" title="启动Harbor"></a>启动Harbor</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h3 id="关闭Harbor"><a href="#关闭Harbor" class="headerlink" title="关闭Harbor"></a>关闭Harbor</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down -v</span><br></pre></td></tr></table></figure>

<h3 id="修改配制后需要重新关停和开启Harbor"><a href="#修改配制后需要重新关停和开启Harbor" class="headerlink" title="修改配制后需要重新关停和开启Harbor"></a>修改配制后需要重新关停和开启Harbor</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./prepare #执行配置脚本</span><br><span class="line">docker-compose down -v #关停Harbor</span><br><span class="line">docker-compose up -d #启动Harbor</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
    <a href="/page/2/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="as_sitesearch" value="ryangsun.github.io">
  </form>
</div>


  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/CI-CD/">CI/CD</a><small>10</small></li>
  
    <li><a href="/categories/Table2Entry/">Table2Entry</a><small>1</small></li>
  
    <li><a href="/categories/%E6%9C%AA%E8%A7%A3%E4%B9%8B%E8%B0%9C/">未解之谜</a><small>1</small></li>
  
    <li><a href="/categories/%E8%AF%AD%E9%9B%80javaSDK/">语雀javaSDK</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/Table2Entry/">Table2Entry</a><small>1</small></li>
  
    <li><a href="/tags/ci-cd/">ci/cd</a><small>10</small></li>
  
    <li><a href="/tags/devops/">devops</a><small>10</small></li>
  
    <li><a href="/tags/dind/">dind</a><small>2</small></li>
  
    <li><a href="/tags/docker/">docker</a><small>10</small></li>
  
    <li><a href="/tags/gitlab/">gitlab</a><small>6</small></li>
  
    <li><a href="/tags/harbor/">harbor</a><small>2</small></li>
  
    <li><a href="/tags/java/">java</a><small>3</small></li>
  
    <li><a href="/tags/jenkins/">jenkins</a><small>1</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>1</small></li>
  
    <li><a href="/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/">持续集成</a><small>10</small></li>
  
    <li><a href="/tags/%E8%AF%AD%E9%9B%80/">语雀</a><small>1</small></li>
  
    <li><a href="/tags/%E8%AF%AD%E9%9B%80javaSDK/">语雀javaSDK</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2022 Ryan.G.Sun
  
</div>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
